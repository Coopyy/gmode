#include "libs.h"
#include "sdk/interfaces.h"
#include "hooks/hooks.h"

DWORD WINAPI Setup(LPVOID lpParam)
{
	/*AllocConsole();
	freopen_s(reinterpret_cast<_iobuf**>(__acrt_iob_func(0)), "conin$", "r", static_cast<_iobuf*>(__acrt_iob_func(0)));
	freopen_s(reinterpret_cast<_iobuf**>(__acrt_iob_func(1)), "conout$", "w", static_cast<_iobuf*>(__acrt_iob_func(1)));
	freopen_s(reinterpret_cast<_iobuf**>(__acrt_iob_func(2)), "conout$", "w", static_cast<_iobuf*>(__acrt_iob_func(2)));*/

	interfaces::setup();
	hooks::load();

	while (!GetAsyncKeyState(VK_END))
		Sleep(200);

	hooks::unload();

	/*fclose(static_cast<_iobuf*>(__acrt_iob_func(0)));
	fclose(static_cast<_iobuf*>(__acrt_iob_func(1)));
	fclose(static_cast<_iobuf*>(__acrt_iob_func(2)));

	FreeConsole();*/

	FreeLibraryAndExitThread(static_cast<HMODULE>(lpParam), EXIT_SUCCESS);
}

BOOL APIENTRY DllMain(HMODULE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
{
	if (fdwReason == DLL_PROCESS_ATTACH)
	{
		DisableThreadLibraryCalls(hinstDLL);

		const HANDLE hThread = CreateThread(nullptr, NULL, Setup, hinstDLL, NULL, nullptr
		);

		if (hThread)
			CloseHandle(hThread);
	}

	return TRUE;
}